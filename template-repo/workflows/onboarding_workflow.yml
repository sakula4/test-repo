name: ğŸš€ {{ tenant_name|title }} Demo Onboarding (Sequential)

on:
  pull_request:
    branches: 
      - main
    paths:
      - '_config/tenants/{{ tenant_name }}/**'
      - 'databricks/**'
      - '.github/workflows/tenant_{{ tenant_name }}.yaml'
      - '.github/workflows/tenant_{{ tenant_name }}_deploy.yaml'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  TENANT: {{ tenant_name }}

jobs:
  # Get PR Details
  pr-details:
    name: ğŸ“‹ Get PR Details
    runs-on: ubuntu-22.04
    outputs:
      pr-number: ${{ steps.pr.outputs.number }}
      pr-title: ${{ steps.pr.outputs.title }}
      pr-author: ${{ steps.pr.outputs.user-login }}
      tenant-name: ${{ env.TENANT }}
    steps:
      - name: Display PR Info
        run: |
          echo "ğŸ¯ DEMO: Processing Tenant Onboarding for: ${{ env.TENANT }}"
          echo "ğŸ“ This is a demonstration of sequential deployment"
          echo "ğŸ‘¤ Simulating real deployment steps with demo outputs"

  # ========================
  # DEMO SEQUENTIAL DEPLOYMENT
  # ========================
  
  # Stage 1: Network Plan
  network-plan-dev:
    name: ğŸ—ï¸ Demo Network Plan (Dev)
    needs: [pr-details]
    runs-on: ubuntu-22.04
    steps:
      - name: Demo Network Plan Output
        run: |
          echo "ğŸ¯ DEMO: network-plan-output"
          echo "ğŸ“¦ Tenant: ${{ env.TENANT }}"
          echo "ğŸŒ Environment: Development"
          echo "ğŸ—ï¸ Component: Network Plan (Demo Mode)"

  # Stage 2: Network Apply Approval
  approve-network-dev:
    name: âœ… Approve Network Deploy (Dev)
    needs: [network-plan-dev]
    runs-on: ubuntu-22.04
    environment: 
      name: approve-dev
    steps:
      - name: Approval Gate
        run: |
          echo "ğŸ¯ Waiting for approval to deploy Network infrastructure"
          echo "ğŸ“¦ Tenant: ${{ env.TENANT }}"
          echo "ğŸŒ Environment: Development"
          echo "ğŸ—ï¸ Component: Network"

  # Stage 3: Network Apply
  network-apply-dev:
    name: ğŸš€ Network Deploy (Dev)
    needs: [approve-network-dev]
    runs-on: ubuntu-22.04
    environment: dev
    steps:
      - name: Demo Network Apply Output
        run: |
          echo "ğŸ¯ DEMO: network-apply-output"
          echo "ğŸ“¦ Tenant: ${{ env.TENANT }}"
          echo "ğŸŒ Environment: Development"
          echo "ğŸš€ Component: Network Apply (Demo Mode)"

  # Stage 4: Network Peering Plan
  network-peering-plan-dev:
    name: ğŸ”— Network Peering Plan (Dev)
    needs: [network-apply-dev]
    runs-on: ubuntu-22.04
    environment: dev
    steps:
      - name: Demo Network Peering Plan Output
        run: |
          echo "ğŸ¯ DEMO: network-peering-plan-output"
          echo "ğŸ“¦ Tenant: ${{ env.TENANT }}"
          echo "ğŸŒ Environment: Development"
          echo "ğŸ”— Component: Network Peering Plan (Demo Mode)"

  # Stage 5: Network Peering Apply Approval
  approve-peering-dev:
    name: âœ… Approve Peering Deploy (Dev)
    needs: [network-peering-plan-dev]
    runs-on: ubuntu-22.04
    environment: 
      name: approve-dev
    steps:
      - name: Approval Gate
        run: |
          echo "ğŸ¯ Waiting for approval to deploy Network Peering"
          echo "ğŸ“¦ Tenant: ${{ env.TENANT }}"
          echo "ğŸŒ Environment: Development"
          echo "ğŸ”— Component: Network Peering"

  # Stage 6: Network Peering Apply
  network-peering-apply-dev:
    name: ğŸš€ Network Peering Deploy (Dev)
    needs: [approve-peering-dev]
    runs-on: ubuntu-22.04
    environment: dev
    steps:
      - name: Demo Network Peering Apply Output
        run: |
          echo "ğŸ¯ DEMO: network-peering-apply-output"
          echo "ğŸ“¦ Tenant: ${{ env.TENANT }}"
          echo "ğŸŒ Environment: Development"
          echo "ğŸš€ Component: Network Peering Apply (Demo Mode)"

  # Stage 7: Credentials Plan
  credentials-plan-dev:
    name: ğŸ” Credentials Plan (Dev)
    needs: [network-peering-apply-dev]
    runs-on: ubuntu-22.04
    environment: dev
    steps:
      - name: Demo Credentials Plan Output
        run: |
          echo "ğŸ¯ DEMO: credentials-plan-output"
          echo "ğŸ“¦ Tenant: ${{ env.TENANT }}"
          echo "ğŸŒ Environment: Development"
          echo "ğŸ” Component: Credentials Plan (Demo Mode)"

  # Stage 8: Credentials Apply Approval
  approve-credentials-dev:
    name: âœ… Approve Credentials Deploy (Dev)
    needs: [credentials-plan-dev]
    runs-on: ubuntu-22.04
    environment: 
      name: approve-dev
    steps:
      - name: Approval Gate
        run: |
          echo "ğŸ¯ Waiting for approval to deploy Credentials"
          echo "ğŸ“¦ Tenant: ${{ env.TENANT }}"
          echo "ğŸŒ Environment: Development"
          echo "ğŸ” Component: Credentials"

  # Stage 9: Credentials Apply
  credentials-apply-dev:
    name: ğŸš€ Credentials Deploy (Dev)
    needs: [approve-credentials-dev]
    runs-on: ubuntu-22.04
    environment: dev
    steps:
      - name: Demo Credentials Apply Output
        run: |
          echo "ğŸ¯ DEMO: credentials-apply-output"
          echo "ğŸ“¦ Tenant: ${{ env.TENANT }}"
          echo "ğŸŒ Environment: Development"
          echo "ğŸš€ Component: Credentials Apply (Demo Mode)"

  # Stage 10: Workspace Plan
  workspace-plan-dev:
    name: ğŸ¢ Workspace Plan (Dev)
    needs: [credentials-apply-dev]
    runs-on: ubuntu-22.04
    environment: dev
    steps:
      - name: Demo Workspace Plan Output
        run: |
          echo "ğŸ¯ DEMO: workspace-plan-output"
          echo "ğŸ“¦ Tenant: ${{ env.TENANT }}"
          echo "ğŸŒ Environment: Development"
          echo "ğŸ¢ Component: Workspace Plan (Demo Mode)"

  # Stage 11: Workspace Apply Approval
  approve-workspace-dev:
    name: âœ… Approve Workspace Deploy (Dev)
    needs: [workspace-plan-dev]
    runs-on: ubuntu-22.04
    environment: 
      name: approve-dev
    steps:
      - name: Approval Gate
        run: |
          echo "ğŸ¯ Waiting for approval to deploy Workspace"
          echo "ğŸ“¦ Tenant: ${{ env.TENANT }}"
          echo "ğŸŒ Environment: Development"
          echo "ğŸ¢ Component: Workspace"

  # Stage 12: Workspace Apply
  workspace-apply-dev:
    name: ğŸš€ Workspace Deploy (Dev)
    needs: [approve-workspace-dev]
    runs-on: ubuntu-22.04
    environment: dev
    steps:
      - name: Demo Workspace Apply Output
        run: |
          echo "ğŸ¯ DEMO: workspace-apply-output"
          echo "ğŸ“¦ Tenant: ${{ env.TENANT }}"
          echo "ğŸŒ Environment: Development"
          echo "ğŸš€ Component: Workspace Apply (Demo Mode)"

  # Final Stage: Cleanup Notification
  onboarding-complete:
    name: ğŸ‰ Onboarding Complete
    needs: [workspace-apply-dev]
    runs-on: ubuntu-22.04
    steps:
      - name: Onboarding Success
        run: |
          echo "ğŸ‰ TENANT ONBOARDING COMPLETED SUCCESSFULLY! ğŸ‰"
          echo "=============================================="
          echo "ğŸ“¦ Tenant: ${{ env.TENANT }}"
          echo "ğŸŒ Environment: Development"
          echo "âœ… All components deployed successfully"
          echo ""
          echo "ğŸ—‘ï¸ NEXT STEPS:"
          echo "1. Merge this PR to activate the regular deployment workflow"
          echo "2. Delete this temporary onboarding workflow file"
          echo "3. Future deployments will use the standard GitOps process"
          echo ""
          echo "ğŸ”„ GitOps Process Now Active:"
          echo "- Push to main â†’ Dev deployment"
          echo "- Tags â†’ Stage/UAT/Prod deployments"
      - name: Create Cleanup Comment
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `
            ## ğŸ‰ Tenant Onboarding Completed Successfully!
            
            **Tenant**: \`${{ env.TENANT }}\`
            **Environment**: Development
            **Status**: âœ… All components deployed
            
            ### ğŸ”„ Next Steps:
            1. **Merge this PR** to activate the regular deployment workflow
            2. **Delete** the temporary onboarding workflow file: \`.github/workflows/onboarding_workflow_${{ env.TENANT }}.yml\`
            3. Future deployments will use the standard GitOps process
            
            ### ğŸš€ GitOps Process Now Active:
            - **Push to main** â†’ Dev deployment  
            - **Tags (v*.*.*)** â†’ Stage/UAT/Prod deployments
            
            The tenant is now ready for production use! ğŸš€
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Automated Cleanup Stage
  auto-cleanup:
    name: ğŸ—‘ï¸ Auto Cleanup Workflow
    needs: [onboarding-complete]
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install GitPython PyGithub

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Extract branch name
        id: branch
        run: |
          echo "branch_name=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Branch: ${{ github.event.pull_request.head.ref }}"

      - name: Run cleanup script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ—‘ï¸ Running automated cleanup for branch: ${{ steps.branch.outputs.branch_name }}"
          python scripts/cleanup_onboard.py "${{ steps.branch.outputs.branch_name }}" --verbose

      - name: Cleanup completion
        run: |
          echo "âœ… AUTOMATED CLEANUP COMPLETED!"
          echo "================================"
          echo "ğŸ—‘ï¸ Onboarding workflow file removed"
          echo "ğŸ’¾ Changes committed and pushed"
          echo "ğŸ’¬ PR comment added"
          echo ""
          echo "ğŸš€ Ready to merge PR for full GitOps activation!"