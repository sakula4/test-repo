name: üîî Ready for Review Notifications

on:
  schedule:
    # Run every 2 hours
    - cron: '0 */2 * * *'
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run notification'
        required: false
        default: 'false'

env:
  TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}

jobs:
  notify-ready-for-review:
    name: Notify Ready for Review PRs
    runs-on: ubuntu-latest
    
    steps:
      - name: Get Pull Requests with 'ready for review' label
        id: get-prs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              // Get all open pull requests
              const { data: pullRequests } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                per_page: 100
              });
              
              console.log(`Found ${pullRequests.length} open pull requests`);
              
              // Filter PRs with 'ready for review' label
              const readyForReviewPRs = pullRequests.filter(pr => 
                pr.labels.some(label => 
                  label.name.toLowerCase().includes('ready for review') ||
                  label.name.toLowerCase().includes('ready-for-review')
                )
              );
              
              console.log(`Found ${readyForReviewPRs.length} PRs ready for review`);
              
              // Format PR data for Teams message
              const prData = readyForReviewPRs.map(pr => {
                const createdDate = new Date(pr.created_at).toLocaleDateString('en-US', {
                  month: 'short',
                  day: 'numeric',
                  year: 'numeric'
                });
                
                const updatedDate = new Date(pr.updated_at).toLocaleDateString('en-US', {
                  month: 'short',
                  day: 'numeric',
                  year: 'numeric'
                });
                
                return {
                  number: pr.number,
                  title: pr.title,
                  author: pr.user.login,
                  created: createdDate,
                  updated: updatedDate,
                  url: pr.html_url,
                  draft: pr.draft,
                  mergeable: pr.mergeable_state,
                  branch: pr.head.ref,
                  base: pr.base.ref,
                  reviewers: pr.requested_reviewers?.map(r => r.login).join(', ') || 'None',
                  labels: pr.labels.map(l => l.name).join(', ')
                };
              });
              
              // Set outputs
              core.setOutput('pr-count', readyForReviewPRs.length);
              core.setOutput('pr-data', JSON.stringify(prData));
              
              return {
                count: readyForReviewPRs.length,
                prs: prData
              };
              
            } catch (error) {
              console.error('Error fetching pull requests:', error);
              core.setFailed(`Failed to fetch pull requests: ${error.message}`);
              return { count: 0, prs: [] };
            }

      - name: Build Teams Message
        id: build-message
        if: steps.get-prs.outputs.pr-count > 0
        run: |
          PR_DATA='${{ steps.get-prs.outputs.pr-data }}'
          PR_COUNT='${{ steps.get-prs.outputs.pr-count }}'
          
          # Start building the Teams message JSON
          cat << 'EOF' > teams_message.json
          {
            "@type": "MessageCard",
            "@context": "http://schema.org/extensions",
            "themeColor": "0076D7",
            "summary": "Pull Requests Ready for Review",
            "sections": [
              {
                "activityTitle": "üîç Pull Requests Ready for Review",
                "activitySubtitle": "Repository: ${{ github.repository }}",
                "activityImage": "https://github.com/images/error/octocat_happy.gif",
                "facts": [
                  {
                    "name": "Total PRs Ready:",
                    "value": "PR_COUNT_PLACEHOLDER"
                  },
                  {
                    "name": "Repository:",
                    "value": "${{ github.repository }}"
                  },
                  {
                    "name": "Triggered by:",
                    "value": "${{ github.event_name }}"
                  },
                  {
                    "name": "Timestamp:",
                    "value": "TIMESTAMP_PLACEHOLDER"
                  }
                ],
                "markdown": true
              }
            ]
          }
          EOF
          
          # Replace placeholders with actual values
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          sed -i "s/PR_COUNT_PLACEHOLDER/$PR_COUNT/g" teams_message.json
          sed -i "s/TIMESTAMP_PLACEHOLDER/$TIMESTAMP/g" teams_message.json
          
          # Parse PR data and build HTML table for Teams with proper structure
          echo "$PR_DATA" | jq -r '
            "<table style=\"border-collapse: collapse; width: 100%;\">" +
            "<thead>" +
            "<tr style=\"background-color: #f1f3f4;\">" +
            "<th style=\"border: 1px solid #ddd; padding: 8px; text-align: left;\">PR</th>" +
            "<th style=\"border: 1px solid #ddd; padding: 8px; text-align: left;\">Title</th>" +
            "<th style=\"border: 1px solid #ddd; padding: 8px; text-align: left;\">Author</th>" +
            "<th style=\"border: 1px solid #ddd; padding: 8px; text-align: left;\">Created</th>" +
            "<th style=\"border: 1px solid #ddd; padding: 8px; text-align: left;\">Branch</th>" +
            "<th style=\"border: 1px solid #ddd; padding: 8px; text-align: left;\">Reviewers</th>" +
            "<th style=\"border: 1px solid #ddd; padding: 8px; text-align: left;\">Status</th>" +
            "</tr>" +
            "</thead>" +
            "<tbody>" +
            (map(
              "<tr>" +
              "<td style=\"border: 1px solid #ddd; padding: 8px;\"><a href=\"\(.url)\">#\(.number)</a></td>" +
              "<td style=\"border: 1px solid #ddd; padding: 8px;\">\(.title | .[0:40] + (if length > 40 then "..." else "" end))</td>" +
              "<td style=\"border: 1px solid #ddd; padding: 8px;\">@\(.author)</td>" +
              "<td style=\"border: 1px solid #ddd; padding: 8px;\">\(.created)</td>" +
              "<td style=\"border: 1px solid #ddd; padding: 8px;\">\(.branch)</td>" +
              "<td style=\"border: 1px solid #ddd; padding: 8px;\">\(.reviewers)</td>" +
              "<td style=\"border: 1px solid #ddd; padding: 8px;\">\(if .draft then "üîÑ Draft" else "‚úÖ Ready" end)</td>" +
              "</tr>"
            ) | join("")) +
            "</tbody>" +
            "</table>"
          ' > pr_table.html
          
          # Read the HTML table
          PR_TABLE=$(cat pr_table.html)
          
          # Add the PR table section to the Teams message
          jq --arg table "$PR_TABLE" '
            .sections += [{
              "activityTitle": "üìã Pull Request Details",
              "text": $table,
              "markdown": false
            }]
          ' teams_message.json > teams_message_final.json
          
          # Add potential actions
          jq '
            .potentialAction = [
              {
                "@type": "OpenUri",
                "name": "View All Pull Requests",
                "targets": [
                  {
                    "os": "default",
                    "uri": "https://github.com/${{ github.repository }}/pulls?q=is%3Aopen+is%3Apr+label%3A%22ready+for+review%22"
                  }
                ]
              },
              {
                "@type": "OpenUri",
                "name": "Repository Home",
                "targets": [
                  {
                    "os": "default",
                    "uri": "https://github.com/${{ github.repository }}"
                  }
                ]
              }
            ]
          ' teams_message_final.json > teams_message_complete.json
          
          echo "MESSAGE_FILE=teams_message_complete.json" >> $GITHUB_OUTPUT

      - name: Send Teams Notification
        if: steps.get-prs.outputs.pr-count > 0
        run: |
          if [ -z "${{ env.TEAMS_WEBHOOK_URL }}" ]; then
            echo "‚ö†Ô∏è TEAMS_WEBHOOK_URL secret not configured. Skipping notification."
            echo "Teams message that would have been sent:"
            cat ${{ steps.build-message.outputs.MESSAGE_FILE }}
            exit 0
          fi
          
          echo "üì§ Sending Teams notification for ${{ steps.get-prs.outputs.pr-count }} PRs ready for review..."
          
          # Send the message to Teams
          RESPONSE=$(curl -s -w "%{http_code}" -o response.json \
            -H "Content-Type: application/json" \
            -d @${{ steps.build-message.outputs.MESSAGE_FILE }} \
            "${{ env.TEAMS_WEBHOOK_URL }}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -c 4)
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "202" ]; then
            echo "‚úÖ Successfully sent Teams notification (HTTP $HTTP_CODE)"
          else
            echo "‚ùå Failed to send Teams notification (HTTP $HTTP_CODE)"
            echo "Response:"
            cat response.json
            exit 1
          fi

      - name: No PRs Ready for Review
        if: steps.get-prs.outputs.pr-count == 0
        run: |
          echo "‚ÑπÔ∏è No pull requests with 'ready for review' label found."
          echo "Current open PRs: $(gh pr list --state open --json number --jq '. | length')"
          echo "Skipping Teams notification."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Debug Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: teams-notification-debug-${{ github.run_number }}
          path: |
            teams_message*.json
            pr_table.html
            response.json
          retention-days: 7