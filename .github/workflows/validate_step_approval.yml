name: Step-by-Step Approval Validation

on:
  workflow_dispatch:
    inputs:
      operation_type:
        description: 'Type of operation to perform'
        required: true
        type: choice
        options:
          - database_migration
          - security_update
          - configuration_change
        default: 'configuration_change'
      description:
        description: 'Description of the operation'
        required: true
        type: string
        default: 'Standard configuration update'

env:
  OPERATION_TYPE: ${{ github.event.inputs.operation_type }}
  DESCRIPTION: ${{ github.event.inputs.description }}

jobs:
  step-by-step-process:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: üèÅ Step 1 - Initial Setup
      run: |
        echo "üöÄ STEP 1: INITIAL SETUP"
        echo "================================"
        echo "Operation Type: ${{ env.OPERATION_TYPE }}"
        echo "Description: ${{ env.DESCRIPTION }}"
        echo "Initiated by: ${{ github.actor }}"
        echo "Workflow Run: ${{ github.run_id }}"
        echo "================================"
        
        # Simulate some initial work
        echo "Preparing workspace..."
        echo "Loading configuration..."
        echo "Validating prerequisites..."
        sleep 2
        echo "‚úÖ Step 1 completed successfully"

    # Approval Gate 1
    - name: üìã Approval Required - Proceed to Step 2
      uses: trstringer/manual-approval@v1
      with:
        secret: ${{ github.TOKEN }}
        approvers: sakula4
        minimum-approvals: 1
        issue-title: "üîí Step 1‚Üí2 Approval: ${{ env.OPERATION_TYPE }}"
        issue-body: |
          ## üîí Step-by-Step Approval Request
          
          **Current Status:** Step 1 completed ‚úÖ
          **Next Step:** Step 2 - Configuration Validation
          
          **Operation Details:**
          - **Type:** ${{ env.OPERATION_TYPE }}
          - **Description:** ${{ env.DESCRIPTION }}
          - **Initiated by:** ${{ github.actor }}
          - **Workflow:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          **Step 1 Results:**
          - ‚úÖ Workspace prepared
          - ‚úÖ Configuration loaded
          - ‚úÖ Prerequisites validated
          
          **Next Step (Step 2) will:**
          - Validate system configuration
          - Check permissions and access
          - Prepare for main operation
          
          **Approval Instructions:**
          - Comment **"approved"** to proceed to Step 2
          - Comment **"denied"** to stop the process
          
          ---
          **Approver:** @sakula4
        exclude-workflow-initiator-as-approver: false
        fail-on-denial: true
        additional-approved-words: 'lgtm,proceed,continue,go'
        additional-denied-words: 'stop,halt,cancel,abort'
        polling-interval-seconds: 30

    - name: üîß Step 2 - Configuration Validation
      run: |
        echo "üîß STEP 2: CONFIGURATION VALIDATION"
        echo "================================"
        echo "Proceeding after Step 1‚Üí2 approval ‚úÖ"
        echo "Operation: ${{ env.OPERATION_TYPE }}"
        echo "================================"
        
        case "${{ env.OPERATION_TYPE }}" in
          "database_migration")
            echo "üóÑÔ∏è Database Migration Validation:"
            echo "- Checking database connectivity..."
            echo "- Validating migration scripts..."
            echo "- Verifying backup procedures..."
            ;;
          "security_update")
            echo "üîí Security Update Validation:"
            echo "- Scanning for vulnerabilities..."
            echo "- Checking security policies..."
            echo "- Validating update packages..."
            ;;
          "configuration_change")
            echo "‚öôÔ∏è Configuration Change Validation:"
            echo "- Loading current configuration..."
            echo "- Validating new settings..."
            echo "- Checking compatibility..."
            ;;
        esac
        
        sleep 3
        echo "‚úÖ Step 2 completed successfully"

    # Approval Gate 2
    - name: üìã Approval Required - Proceed to Step 3
      uses: trstringer/manual-approval@v1
      with:
        secret: ${{ github.TOKEN }}
        approvers: sakula4
        minimum-approvals: 1
        issue-title: "ÔøΩ Step 2‚Üí3 Approval: ${{ env.OPERATION_TYPE }} - Execute Operation"
        issue-body: |
          ## ÔøΩ Final Step Approval Request
          
          **Current Status:** Steps 1-2 completed ‚úÖ
          **Next Step:** Step 3 - Execute Main Operation (FINAL STEP)
          
          **Operation Details:**
          - **Type:** ${{ env.OPERATION_TYPE }}
          - **Description:** ${{ env.DESCRIPTION }}
          - **Initiated by:** ${{ github.actor }}
          
          **Completed Steps:**
          - ‚úÖ Step 1: Initial setup and preparation
          - ‚úÖ Step 2: Configuration validation and checks
          
          **‚ö†Ô∏è FINAL STEP (Step 3) will execute:**
          ${{ env.OPERATION_TYPE == 'database_migration' && '- **DATABASE MIGRATION** - This will modify the database schema!' || '' }}
          ${{ env.OPERATION_TYPE == 'security_update' && '- **SECURITY UPDATE** - This will apply security patches!' || '' }}
          ${{ env.OPERATION_TYPE == 'configuration_change' && '- **CONFIGURATION CHANGE** - This will modify system settings!' || '' }}
          
          **‚ö†Ô∏è WARNING: This is the final approval before execution!**
          
          **Approval Instructions:**
          - Comment **"approved"** to execute the final step
          - Comment **"denied"** to stop before execution
          
          ---
          **Approver:** @sakula4
          **‚ö†Ô∏è Please review carefully before approving final execution**
        exclude-workflow-initiator-as-approver: false
        fail-on-denial: true
        additional-approved-words: 'lgtm,execute,proceed,final-go'
        additional-denied-words: 'stop,halt,cancel,abort,no'
        polling-interval-seconds: 30

    - name: ‚ö° Step 3 - Execute Main Operation
      run: |
        echo "‚ö° STEP 3: EXECUTE MAIN OPERATION"
        echo "================================"
        echo "üö® FINAL EXECUTION APPROVED ‚úÖ"
        echo "Operation: ${{ env.OPERATION_TYPE }}"
        echo "Description: ${{ env.DESCRIPTION }}"
        echo "================================"
        
        case "${{ env.OPERATION_TYPE }}" in
          "database_migration")
            echo "üóÑÔ∏è Executing Database Migration:"
            echo "- Creating backup..."
            sleep 2
            echo "- Running migration scripts..."
            sleep 4
            echo "- Validating migration results..."
            sleep 2
            echo "- Updating schema version..."
            echo "‚úÖ Database migration completed successfully!"
            ;;
          "security_update")
            echo "ÔøΩ Executing Security Update:"
            echo "- Downloading security patches..."
            sleep 2
            echo "- Applying security updates..."
            sleep 4
            echo "- Restarting affected services..."
            sleep 2
            echo "- Validating security status..."
            echo "‚úÖ Security update completed successfully!"
            ;;
          "configuration_change")
            echo "‚öôÔ∏è Executing Configuration Change:"
            echo "- Backing up current configuration..."
            sleep 2
            echo "- Applying new configuration..."
            sleep 3
            echo "- Validating configuration..."
            sleep 2
            echo "- Reloading services..."
            echo "‚úÖ Configuration change completed successfully!"
            ;;
        esac

    - name: üéâ Process Complete
      run: |
        echo "üéâ ALL STEPS COMPLETED SUCCESSFULLY"
        echo "================================"
        echo "‚úÖ Step 1: Initial Setup - Completed"
        echo "‚úÖ Step 2: Configuration Validation - Completed" 
        echo "‚úÖ Step 3: Main Operation Execution - Completed"
        echo "================================"
        echo "üìã Summary:"
        echo "- Operation Type: ${{ env.OPERATION_TYPE }}"
        echo "- Description: ${{ env.DESCRIPTION }}"
        echo "- Initiated by: ${{ github.actor }}"
        echo "- Approved by: sakula4 (at each step)"
        echo "- Total Steps: 3"
        echo "- Approval Gates: 2"
        echo "- Status: SUCCESS ‚úÖ"
        echo "================================"
        echo "üîó Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"